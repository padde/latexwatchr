def activate_app app_name
  script = <<-OSASCRIPT
    tell application "#{app_name}"
      activate
    end tell
  OSASCRIPT
  
  system "osascript -e '#{script}'"
end

def compile_latex file, output_dir
  system "pdflatex -halt-on-error -output-directory #{output_dir} #{file}"
end

def notify message, message_type
  icon = case message_type
    when :success then ".growl_icons/success.png"
    when :error   then ".growl_icons/error.png"
  end
  
  system "growlnotify -n latexwatchr --image #{icon} -m \"#{message}\" LaTeXwatchr"
end



output_dir = "./output/"
FileUtils.mkdir_p output_dir

puts "Watching .tex files..."

watch /.*\.tex/ do |md|
  texfile = md[0]
  outfile = output_dir + md[0].gsub(/tex$/, 'pdf')
  
  if compile_latex texfile, output_dir
    notify "Compiled #{texfile}", :success
    activate_app "Preview"
  else
    notify "Error in #{texfile}", :error
    activate_app "Terminal"
  end
end